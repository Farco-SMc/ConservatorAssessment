<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FARCO — Conservator assessment</title>
<style>
  /* ==================================================================
     Custom font-face declarations
  ================================================================== */
  /* Gill Sans Light */
  @font-face {
    font-family: 'Gill Sans';
    src: url('<?= fonts.gillLight ?>') format('woff');
    font-weight: 300;
    font-style: normal;
    font-display: swap;
  }
  /* Gill Sans Regular */
  @font-face {
    font-family: 'Gill Sans';
    src: url('<?= fonts.gillRegular ?>') format('woff');
    font-weight: 400;
    font-style: normal;
    font-display: swap;
  }
  /* Gill Sans Medium (used for semi bold/strong text) */
  @font-face {
    font-family: 'Gill Sans';
    src: url('<?= fonts.gillMedium ?>') format('woff');
    font-weight: 600;
    font-style: normal;
    font-display: swap;
  }
  /* Gill Sans Bold */
  @font-face {
    font-family: 'Gill Sans';
    src: url('<?= fonts.gillBold ?>') format('woff');
    font-weight: 700;
    font-style: normal;
    font-display: swap;
  }
  /* Begum SemiBold */
  @font-face {
    font-family: 'Begum Semibold';
    src: url('<?= fonts.begum ?>') format('woff');
    font-weight: 600;
    font-style: normal;
    font-display: swap;
  }

  /* Utility class to hide elements when needed */
  .hide{display:none !important;}

  /* Treatment row: custom sits just after quick picks */
  .treatbar{display:flex;gap:28px;align-items:flex-end;flex-wrap:wrap;margin-top:6px}
  .treatbar .quick{flex:0 1 auto}
  .treatbar .treatcustom{flex:0 0 320px}

  /* Checkbox grid polish */
  .checkgrid{grid-template-columns:repeat(auto-fit,minmax(280px,1fr));}
  .checkitem{align-items:flex-start}
  .checkitem input[type="checkbox"]{margin-top:4px}
  .checkitem .label{line-height:1.3;word-break:break-word;hyphens:auto}

  /* Treatment time inline row */
  .treatbar{display:flex;gap:28px;align-items:flex-end;flex-wrap:wrap;margin-top:6px}
  .treatbar .quick label,.treatbar .treatcustom label{display:block;margin:0 0 6px;font-weight:600;color:var(--ink)}
  #timeQuick{margin:0}
  #timeQuick .chip{cursor:pointer}
  .treatcustom .inputs{display:flex;gap:10px;align-items:center}
  .treatcustom .inputs input{width:160px}
  .treatcustom .inputs select{width:130px;min-height:46px;border-radius:var(--field-radius);border:1px solid var(--stroke);background:#fff}
  #timePreview{margin-top:8px}

  /* Treatment time inline layout */
  .treatbar{display:flex;gap:24px;align-items:flex-end;flex-wrap:wrap;margin-top:8px;}
  #timeQuick{margin:0;}
  .treatcustom label{display:block;margin:0 0 6px;font-weight:600;color:var(--ink)}
  .treatcustom .inputs{display:flex;gap:10px;align-items:center}
  .treatcustom .inputs input{width:160px}
  .treatcustom .inputs select{width:130px;min-height:46px;border-radius:var(--field-radius);border:1px solid var(--stroke);background:#fff}

  /* Treatment preview spacing */
  #timePreview { margin-top: 6px; }
  #timeQuick .chip { background:#fff; cursor: pointer; }

  #hist_notes_box.hide{display:none !important}

  /* Softer helper text */
  .note{ font-size: 0.92em; font-style: italic; }

  /* Align group 'Clear' with the header and remove extra vertical gap */
  .group{ position: relative; }
  .group h4{ margin:12px 0 10px; padding-right:110px; }
  .group .toolbar{ 
    position:absolute; 
    top:4px; 
    right:12px; 
    margin:0; 
    padding:0; 
    display:flex; 
    align-items:center;
  }
  .group .toolbar .mini{ margin-left:0; }

  /* Normalize fonts for form controls */
  textarea, input, select, button {
    font: inherit;
    color: inherit;
  }
  textarea {
    line-height: 1.4;
  }

  :root{
    --bg:#f6f8fc;
    --surface:#ffffff;
    --ink:#26323a;
    --muted:#66737b;
    --accent:#f7941d;
    --stroke:#e7ebf0;
    --stroke-strong:#d2d6dc;
    --focus:#ffb14f;
    --shadow:0 2px 6px rgba(20,32,45,.06), 0 10px 30px rgba(20,32,45,.08);
    --radius:16px;
    --field-radius:12px;
    --highlight:#fff7ef;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:'Gill Sans',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol',sans-serif}
  *{box-sizing:border-box}
  .wrap{max-width:1160px;margin:0 auto;padding:20px 22px 110px}
  .brandbar{margin:6px 0 10px}
  .brandbar .kicker{font-family:'Gill Sans';letter-spacing:.3em;text-transform:uppercase;color:var(--accent);font-size:13px;font-weight:600}
  h1{font-family:'Begum Semibold';font-weight:600;letter-spacing:.2px;margin:10px 0 6px;font-size:28px}
  h2{font-family:'Begum Semibold';font-weight:600;margin:0 0 16px;font-size:20px;letter-spacing:.2px}
  h3{font-family:'Begum Semibold';font-weight:600;margin:0 0 10px;font-size:16px}
  h4{font-family:'Begum Semibold';font-weight:600;margin:12px 0 8px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px}
  p,.note{color:var(--muted)}

  label{display:block;margin:0 0 6px;font-family:'Gill Sans';font-weight:600;color:var(--ink)}
  input[type=text],input[type=number],select,textarea{
    width:100%;padding:13px 14px;border-radius:var(--field-radius);
    border:1px solid var(--stroke);background:#fff;color:#0c1116;
    min-height:46px;line-height:1.24;
    box-shadow:inset 0 1px 0 rgba(0,0,0,.02);
    transition:border-color .15s,box-shadow .15s,background-color .15s
  }
  textarea{min-height:104px;resize:vertical}
  input::placeholder,textarea::placeholder{color:#9aa3aa}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--focus);box-shadow:0 0 0 3px rgba(247,148,29,.25)}
  input[type=checkbox],input[type=radio]{accent-color:var(--accent)}

  .card{background:var(--surface);border:1px solid var(--stroke);border-radius:var(--radius);padding:24px 22px 20px;margin:18px 0;box-shadow:var(--shadow)}
  
  

  .chips{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 4px}
  .chip input{display:none}
  .chip label{display:inline-block;padding:11px 16px;border:1px solid var(--stroke);border-radius:999px;cursor:pointer;background:#fff;color:#26323a;font-family:'Gill Sans';font-weight:600;transition:all .15s}
  .chip input:checked+label{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 6px 16px rgba(247,148,29,.28)}
  .chip label:hover{border-color:var(--stroke-strong)}

  .group{border:1px dashed var(--stroke);border-radius:var(--radius);padding:10px 12px;background:#fff}
  .group+.group{margin-top:14px}
  .group .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:2px 0 6px}
  .group .toolbar .mini{display:flex;gap:8px;align-items:center;margin-left:auto}
  .mini .toggle{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)}
  .mini .btnlink{border:1px solid var(--stroke);background:#fff;border-radius:10px;padding:7px 10px;cursor:pointer;font-weight:600}
  .mini .btnlink:hover{border-color:var(--stroke-strong)}
  .checkgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px 22px;margin-bottom:14px}
  .checkitem{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start;padding:10px;border-radius:12px;transition:background .15s,box-shadow .15s,border-color .15s}
  .checkitem .label{font-weight:600;cursor:pointer;padding-right:4px}
  .checkitem .inline{flex-basis:100%;width:100%;margin:8px 0 0 28px}
  .checkitem .inline.hide{display:none}
  .checkitem.checked{background:var(--highlight);border-left:4px solid var(--accent);padding-left:6px;box-shadow:0 1px 0 rgba(247,148,29,.12)}

  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 14px}
  .tab-btn{border:1px solid var(--stroke);background:#fff;border-radius:999px;padding:8px 14px;font-family:'Gill Sans';font-weight:700;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
  .tab-btn .badge{display:inline-block;min-width:22px;height:22px;border-radius:999px;background:#f0f3f7;color:#19222a;font-size:12px;line-height:22px;text-align:center;padding:0 6px}
  .tab-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .tab-btn.active .badge{background:rgba(255,255,255,.25);color:#fff}
  .tabpanel{display:none}
  .tabpanel.active{display:block}

  .summary{margin-top:14px;border:1px solid var(--stroke);background:#fff;border-radius:12px;padding:12px}
  .summary h4{margin:0 0 8px}
  .selgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:8px}
  .selrow{position:relative;border:1px solid var(--stroke);border-radius:12px;background:#fff;padding:10px 38px 10px 12px}
  .selrow .title{font-weight:700}
  .selrow .meta{font-size:12px;color:var(--muted);margin-top:2px}
  .selrow .pillx{position:absolute;top:8px;right:8px;border:1px solid var(--stroke);background:#fff;border-radius:9px;width:26px;height:26px;line-height:24px;text-align:center;font-weight:700;cursor:pointer}
  .selrow .pillx:hover{border-color:var(--stroke-strong)}

  .stickybar{position:fixed;left:0;right:0;bottom:14px;display:flex;justify-content:center;z-index:80;pointer-events:none}
  .stickybar .inner{background:#fff;border:1px solid var(--stroke);border-radius:999px;box-shadow:var(--shadow);padding:6px 10px;pointer-events:auto;display:flex;align-items:center;gap:10px}
  .stickybar 
  .stickybar.hide{opacity:0;pointer-events:none;transform:translateY(6px);transition:opacity .15s,transform .15s}
  .stickybar.show{opacity:1;transform:translateY(0);transition:opacity .15s,transform .15s}

  #overview .field-row{display:flex;flex-wrap:wrap;gap:24px 28px;align-items:flex-start;margin-bottom:14px}
  #overview .field{display:flex;flex-direction:column;gap:8px;margin:0}
  #overview .field-row>.field{flex:1 1 360px;max-width:520px}
  #overview .item-peril-row{display:grid;grid-template-columns:minmax(320px,520px) 1fr;gap:28px;align-items:start;margin-top:6px}
  #overview .peril-wrap .chips{margin-top:4px}

  .footer{display:flex;justify-content:flex-end;align-items:center;margin-top:10px}
  
  
  

  @media print{
    .stickybar,.toolbar,.chips input,.btn,.modal,.thumbs,.note{display:none!important}
    .card{box-shadow:none;border-color:#ddd}
    body{background:#fff}
  }

  .treatbar{
    display:grid;
    grid-template-columns:max-content 340px;
    gap:12px 28px;
    align-items:start;
    margin-top:12px;
  }
  .treatbar .quick label,
  .treatbar .treatcustom label{
    display:block;
    margin:0 0 8px;
    font-weight:600;
  }
  #timeQuick{margin:2px 0 6px;}
  .treatcustom .inputs{
    display:grid;
    grid-template-columns:1fr 150px;
    gap:12px;
    align-items:center;
  }
  .treatcustom .inputs input{width:100%;}
  .treatcustom .inputs select{
    width:100%;
    min-height:46px;
    border-radius:var(--field-radius);
    border:1px solid var(--stroke);
    background:#fff;
  }
  #timePreview{margin-top:10px;}
  @media (max-width: 780px){
    .treatbar{ grid-template-columns:1fr; }
  }

  
  
  
  .thumbs{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-top:12px;
  }
  .thumb{
    position:relative;
    border:1px solid var(--stroke);
    border-radius:var(--field-radius);
    overflow:hidden;
    width:160px;
    height:120px;
  }
  .thumb img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .thumb button.delete{
    position:absolute;
    top:4px;
    right:4px;
    background:rgba(255,255,255,0.8);
    border:none;
    border-radius:50%;
    width:26px;
    height:26px;
    line-height:24px;
    text-align:center;
    cursor:pointer;
    box-shadow:0 1px 3px rgba(0,0,0,0.2);
  }
  .thumb button.delete:hover{
    background:rgba(255,255,255,1);
  }

  .checkitem .replacement{ flex-basis:100%; width:100%; margin:8px 0 0 28px; }

/* Busy overlay + spinner */
.busy{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:120;align-items:center;justify-content:center}
.busy .spinner{width:44px;height:44px;border-radius:50%;border:4px solid rgba(255,255,255,.35);border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
/* Toast */
.toast{position:fixed;left:50%;bottom:30px;transform:translateX(-50%);background:rgba(38,50,58,0.94);color:#fff;padding:12px 16px;border-radius:10px;font-weight:600;display:none;z-index:130}
.toast.show{display:block}


/* ===== Strong mobile overrides ===== */
@media (max-width: 640px){
  html,body{ font-size: 15px; }
  h1{ font-size: clamp(20px, 4.5vw, 24px); margin: 8px 0; }
  h2{ font-size: clamp(16px, 4vw, 20px); margin: 0 0 10px; }
  h3{ font-size: clamp(14px, 3.8vw, 17px); margin: 0 0 8px; }
  h4{ font-size: 11px; letter-spacing: .6px; }
  .wrap{ padding: 16px 12px calc(120px + env(safe-area-inset-bottom, 0px)); }
  .card{ padding: 14px 12px; margin: 10px 0; }
  
  
  #overview .field-row{ gap: 12px; }
  #overview .field-row>.field{ flex: 1 1 100%; max-width: none; }
  #overview .item-peril-row{ grid-template-columns: 1fr; gap: 12px; }
  .chips{ gap: 8px; }
  .chip label{ padding: 10px 12px; }
  input[type=text],input[type=number],select,textarea{ min-height: 48px; }
  .checkgrid{ grid-template-columns: 1fr; gap: 8px; }
  .selgrid{ grid-template-columns: 1fr; }
  .treatbar{ grid-template-columns: 1fr !important; gap: 10px; }
  .treatcustom .inputs{ grid-template-columns: 1fr 1fr; }
  .thumbs{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .thumb{ width: auto; height: 92px; }
  #saveFooter 
  .stickybar{ left:0; right:0; bottom: calc(10px + env(safe-area-inset-bottom,0px)); padding: 0 12px; }
  .stickybar .inner{ width: 100%; }
  .stickybar 
  .note{ font-size: .95em; }
  .toast{ bottom: calc(30px + env(safe-area-inset-bottom, 0px)); }

  /*
    Consistent card heading sizes on mobile
    --------------------------------------
    Some headings within the form (for example "Incident impact level",
    "Incident findings" and "Historic issues present?") were
    rendering noticeably larger than those earlier in the form.  This
    occurred because the browser applied viewport-based `vw` sizing to
    the `<h2>` and `<h3>` elements by default, which made later
    headings appear out of proportion.  To fix this we explicitly set
    fixed font sizes for headings inside cards when the viewport is
    narrow.  This ensures a consistent hierarchy throughout the
    form.

    The `<h2>` elements are used for section titles such as "2. Item
    details & impact" and "3. Incident findings".  The `<h3>` elements
    are used for subheadings like "Incident impact level".  The
    `<h4>` elements are used for tertiary headings such as
    "Selected Issues".  Reducing their font sizes on mobile keeps the
    layout balanced without overwhelming the user.
  */
  .card > h2{ font-size: 1.1rem; }
  .card h3{ font-size: 1rem; }
  .card h4{ font-size: 0.95rem; text-transform:none; letter-spacing:0; }

  /*
    Reduce font size for helper notes and placeholders on mobile. The
    .note elements (used for hints such as "Choose the overall impact
    level…", "Enter a number…" and "Saved to the client photo folder")
    were showing up too large relative to their associated labels and
    inputs.  Dialing back their size to 0.85em keeps them
    unobtrusive while still readable.  Similarly, the placeholders in
    the additional/other notes textareas now use a smaller font size
    so that they don’t dominate the form when empty.
  */
  .note{
    font-size: 0.85em;
  }
  #incidentNotes::placeholder,
  #otherNotes::placeholder {
    font-size: 0.9rem;
  }

  /*
    The mobile view for Section 3 (Incident findings) and subsequent
    sections was rendering some headings and labels much larger than
    intended.  This made the "Incident impact level" heading, the
    Selected Issues summary and the additional notes area feel out of
    proportion compared to the rest of the form.  To improve
    readability and bring these elements back in line with the rest
    of the page we explicitly scale down fonts for these parts of
    the interface on narrow screens.

    Reducing the font size of the h3/h4 headings, labels and the
    content inside the summary grid ensures a consistent visual
    hierarchy across the form.  Without these overrides the browser
    would apply the default heading sizes, which are too large when
    combined with the base font-size increase defined earlier in
    this mobile media query.
  */
  /* Smaller headings for subsections like "Incident impact level" */
  #incidentSection h2,
  #incidentSection h3,
  #incidentSection h4 {
    font-size: 1rem;
  }
  /* Scale down labels in the incident and historic sections */
  #incidentSection label,
  #hist_notes_box label,
  #hist_notes_box textarea,
  #incidentNotesBox label {
    font-size: 0.92rem;
  }
  /* Fine‑tune the summary box typography */
  #incidentSection .summary h4 {
    font-size: 0.92rem;
    text-transform: none;
    margin-bottom: 6px;
  }
  #incidentSection .selrow .title {
    font-size: 0.9rem;
  }
  #incidentSection .selrow .meta {
    font-size: 0.8rem;
  }
  /* Prevent oversized text in the "Other notes" section */
  #otherNotes + .note {
    font-size: 0.92rem;
  }
}


  /* --- Treatment Time chip styles --- */
  #timeQuick .chip { background:#fff; 
    display: inline-block; 
    padding: 10px 14px; 
    border: 1px solid var(--stroke); 
    border-radius: 999px; 
    user-select: none; 
    margin-right: 8px;
  }
  #timeQuick .chip label{ pointer-events:none; border:none; background:transparent; padding:0; }
  #timeQuick .chip.active { 
    background: var(--accent); 
    color: #fff; 
    border-color: var(--accent);
  }
  #timeQuick .chip.active label{ color:#fff; background: transparent; border-color: transparent; }


  /* Fun trash icon styling */
  .delete{ display:flex; align-items:center; justify-content:center; }
  .delete svg{ width:18px; height:18px; }
  .delete:hover{ transform: rotate(-6deg) scale(1.05); }
  .delete:active{ transform: rotate(0deg) scale(0.98); }
  @media (prefers-reduced-motion: reduce){
    .delete:hover,.delete:active{ transform:none; }
  }
  body.modal-open{ overflow:hidden; }

  .photo-hint{ margin-top:8px; font-size:0.92em; color: var(--muted); }
  .btn.primary:disabled{ opacity: .5; cursor: not-allowed; }

/* ===== Section 1 (Assessment overview) — responsive fix =====
   Goal: avoid the “weird middle” by stacking *only* the Item type + Peril type
   pair on tablet widths, while keeping the rest of the row flexible.
   Approach: target the 3rd and 4th fields inside #overview .field-row.
------------------------------------------------------------------ */

/* Ensure chips can wrap nicely at all sizes */
#overview .peril-wrap .chips{ display:flex; flex-wrap:wrap; gap:10px; }

/* Phones & tablets: stack Item type and Peril type full-width */
@media (max-width: 991.98px){
  #overview .field-row > .field:nth-child(3),
  #overview .field-row > .peril-wrap{
    flex: 1 1 100% !important;
    max-width: none !important;
    width: 100% !important;
  }
}

/* Large screens: comfortable two-column layout */
@media (min-width: 992px){
  #overview .field-row{ gap: 24px 28px; }
  #overview .field-row > .field{ flex: 1 1 360px; max-width: 520px; }
}


/* Tablet-specific stacking for Item/Peril (821–991px)
   Keep Client + Assessor side-by-side; force Item type & Peril type to full-width rows. */
@media (min-width: 821px) and (max-width: 991.98px){
  #overview .field-row{
    display: grid !important;
    grid-template-columns: minmax(340px, 1fr) minmax(340px, 1fr);
    gap: 24px 28px;
    align-items: start;
  }
  #overview .field-row > .field:nth-child(1){ grid-column: 1; }
  #overview .field-row > .field:nth-child(2){ grid-column: 2; }
  #overview .field-row > .field:nth-child(3){ grid-column: 1 / -1; }
  #overview .field-row > .peril-wrap{ grid-column: 1 / -1; }
}


/* ===== Definitive fix: Section 1 Item/Peril single column up to 991px ===== */
@media (max-width: 991.98px){
  #overview .item-peril-row{
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 14px !important;
    align-items: start;
  }
  #overview .item-peril-row .field{
    width: 100% !important;
    max-width: none !important;
  }
  #overview .peril-wrap .chips{ display:flex; flex-wrap:wrap; gap:10px; }
}

/* Desktop only (>=992px): comfortable two-column layout */
@media (min-width: 992px){
  #overview .item-peril-row{
    display: grid !important;
    grid-template-columns: minmax(380px, 520px) 1fr !important;
    gap: 28px !important;
  }
}


/* ===== Section 6 (Treatment time) — stack on tablets (821–991px) ===== */
@media (min-width: 821px) and (max-width: 991.98px){
  .treatbar{
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 14px !important;
    align-items: start;
  }
  .treatbar .quick,
  .treatbar .treatcustom{
    width: 100% !important;
    max-width: none !important;
  }
  /* Keep unit+number inputs tidy on one line if space allows */
  .treatcustom .inputs{
    display: grid !important;
    grid-template-columns: 1fr 150px !important; /* time value + unit select */
    gap: 8px 12px !important;
  }
}


/* ===============================================================
   MOBILE-FIRST TIDY PASS — Single breakpoint (≥992px)
   Removes reliance on earlier 576/640/768/820/821–991 rules.
   Base: phones & tablets. Desktop enhancements only at 992+.
=============================================================== */

/* === Base (≤991px): stack-friendly defaults === */
#overview .field-row{ display:flex; flex-wrap:wrap; gap:14px; align-items:flex-start; }
#overview .field-row > .field{ flex: 1 1 100%; max-width: none; }
#overview .item-peril-row{ display:grid; grid-template-columns: 1fr; gap: 14px; align-items:start; }
#overview .item-peril-row .field{ width:100%; max-width:none; }
#overview .peril-wrap .chips{ display:flex; flex-wrap:wrap; gap:10px; }

.treatbar{ display:grid; grid-template-columns: 1fr; gap:14px; align-items:start; }
.treatbar .quick, .treatbar .treatcustom{ width:100%; max-width:none; }
.treatcustom .inputs{ display:grid; grid-template-columns: 1fr 1fr; gap:8px 12px; }

/* === Safety overrides for legacy rules marked !important === */
@media (max-width: 991.98px){
  #overview .field-row > .field{ flex: 1 1 100% !important; max-width:none !important; }
  #overview .item-peril-row{ display:grid !important; grid-template-columns: 1fr !important; gap:14px !important; }
  .treatbar{ display:grid !important; grid-template-columns: 1fr !important; gap:14px !important; }
  .treatbar .quick, .treatbar .treatcustom{ width:100% !important; max-width:none !important; }
  .treatcustom .inputs{ display:grid !important; grid-template-columns: 1fr 1fr !important; }
}

/* === Desktop (≥992px): comfortable two-column layouts === */
@media (min-width: 992px){
  #overview .field-row{ gap: 24px 28px; }
  #overview .field-row > .field{ flex: 1 1 360px; max-width: 520px; }
  #overview .item-peril-row{ grid-template-columns: minmax(380px, 520px) 1fr; gap: 28px; }

  .treatbar{ grid-template-columns: max-content 340px; gap:12px 28px; }
  .treatcustom .inputs{ grid-template-columns: 1fr 150px; }
}


/* === Sticky save bar spacing for tablet band (821–991px) and generally ≤991px === */
@media (max-width: 991.98px){
  body{ padding-bottom: max(104px, calc(env(safe-area-inset-bottom) + 80px)) !important; }
  .stickybar .inner{ width: calc(100% - 24px); }
}


/* === Override legacy tablet grid on Section 1's first row (Client/Assessor) === */
@media (min-width: 821px) and (max-width: 991.98px){
  #overview .field-row{
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 14px !important;
  }
  #overview .field-row > .field{
    flex: 1 1 100% !important;
    max-width: none !important;
    width: 100% !important;
  }
}

</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

<style id="theme-overrides">
  :root{
    --bs-primary: #F97316; /* orange-500 */
    --bs-primary-rgb: 249, 115, 22;
    --bs-link-color: var(--bs-primary);
    --bs-link-hover-color: #d65f0f;
    --bs-border-radius: .75rem;
    --bs-border-radius-sm: .6rem;
    --bs-border-radius-lg: 1rem;
    --bs-border-radius-xl: 1.25rem;
  
  --shadow: 0 6px 14px rgba(18,28,45,.10), 0 22px 50px rgba(18,28,45,.16);
  --bs-btn-font-family: 'Gill Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;}
  body{ line-height: 1.6; background:#f4f6fa; }
  .wrap.container{ padding-top: 2rem !important; padding-bottom: 3rem !important; }
  .card{ border: 0; }
  .card.rounded-4{ border-radius: 1rem !important; }
  .card .card-body{ padding: 1.25rem 1.25rem; }
  .form-label{ margin-bottom: .5rem; }
  .form-control, .form-select{
    border-radius: var(--bs-border-radius);
    min-height: calc(1.5em + .9rem + 2px);
  }
  .form-control:focus, .form-select:focus{
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 .25rem rgba(var(--bs-primary-rgb), .25);
    outline: 0;
    caret-color: var(--bs-primary);
  }
  .btn:focus, .btn-check:focus + .btn{
    box-shadow: 0 0 0 .25rem rgba(var(--bs-primary-rgb), .3);
  }
  .btn-primary{
    --bs-btn-bg: var(--bs-primary);
    --bs-btn-border-color: var(--bs-primary);
    --bs-btn-hover-bg: #ff8a2a;
    --bs-btn-hover-border-color: #ff8a2a;
    --bs-btn-active-bg: #e96d12;
    --bs-btn-active-border-color: #e96d12;
  }
  /* Make chips/toggle buttons pleasantly pill-shaped if used */
  .btn-check + .btn{ border-radius: 999px; }
  /* Roomier vertical rhythm for stacked fields */
  .form-control, .form-select, .form-check{ margin-bottom: .75rem; }
  /* Softer modal */
  .modal-content{ border: 0; border-radius: 1rem; }
  /* Slightly larger gutters on mobile -> reduce crowding */
  .row.g-4, .gx-4, .gy-4{ --bs-gutter-x: 1.5rem; --bs-gutter-y: 1.5rem; }

/* Ensure Bootstrap buttons use the Gill Sans body font */
.btn{ 
  font-family: var(--bs-btn-font-family, 'Gill Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif);
  font-weight: 600;
}
.btn span, .btn b, .btn strong{ font-family: inherit; }

/* ====================
   Mobile layout fixes
   ==================== */
@media (max-width: 576px){
  /* Make treatment inputs stack nicely and avoid overflow */
  .treatbar{ flex-direction: column; align-items: stretch; gap: 12px; }
  .treatcustom{ flex: 1 1 auto; }
  .treatcustom .inputs{ display:flex; flex-wrap: nowrap; }
  .treatcustom .inputs input{ flex: 1 1 auto; min-width: 0; }
  .treatcustom .inputs select{ flex: 0 0 130px; } /* fixed width for unit selector */
  
  /* Ensure enough space for the sticky save bar on small screens */
  body{ padding-bottom: 96px; }
  .stickybar .inner{ width: calc(100% - 24px); }
}

/* Respect iOS/Android safe area for bottom-fixed elements */
@supports (padding: max(0px)){
  .stickybar{ bottom: max(14px, env(safe-area-inset-bottom)); }
  body{ padding-bottom: max(96px, calc(env(safe-area-inset-bottom) + 72px)); }
}

/* Section 1 (Assessment overview) mobile layout */
@media (max-width: 576px){
  .field-row{ flex-direction: column; gap: 14px; }
  .item-peril-row{ grid-template-columns: 1fr; gap: 14px; }
  .peril-wrap .chips{ display:flex; flex-wrap:wrap; gap: 10px; }
  .peril-wrap .chip{ flex: 0 0 auto; }
}

/* ===== Stronger mobile fixes (wider breakpoint, higher precedence) ===== */
@media (max-width: 768px){
  /* Section 1: force full-width stacked layout */
  .field-row{ flex-direction: column !important; gap: 14px !important; }
  .item-peril-row{ display:block !important; }
  .item-peril-row .field{ width: 100% !important; }
  .peril-wrap .chips{ display:flex; flex-wrap:wrap; gap: 10px; }
  .peril-wrap .chip{ flex: 0 0 auto; }

  /* Treatment time layout */
  .treatbar{ flex-direction: column !important; align-items: stretch !important; gap: 12px !important; }
  .treatcustom{ flex: 1 1 auto !important; }
  .treatcustom .inputs{ display:flex; flex-wrap: nowrap; }
  .treatcustom .inputs input{ flex: 1 1 auto; min-width: 0; }
  .treatcustom .inputs select{ flex: 0 0 132px; }

  /* Sticky save bar space */
  body{ padding-bottom: 104px; }
  .stickybar .inner{ width: calc(100% - 24px); }
}

/* Safe area support for bottom-fixed elements */
@supports (padding: max(0px)){
  .stickybar{ bottom: max(14px, env(safe-area-inset-bottom)); }
  body{ padding-bottom: max(104px, calc(env(safe-area-inset-bottom) + 80px)); }
}

/* ===== Requested layout changes ===== */
@media (max-width: 820px){
  /* Section 1: put Peril type underneath Item type */
  .item-peril-row{
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 14px !important;
  }
  .item-peril-row .peril-wrap{ margin-top: 4px; }
  
  /* Treatment time: show quick picks on two lines */
  #timeQuick{
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    gap: 10px !important;
  }
  #timeQuick .chip{ width: 100%; }
  #timeQuick .chip label{ display:block; width:100%; text-align:center; }
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
<div class="wrap container py-4 py-md-5">
  <div class="brandbar">
    <div class="kicker">Fine Art Restoration Company</div>
    <h1>
      <img src="logo.png" 
     alt="FARCO Logo" 
     style="height:40px;vertical-align:middle;margin-right:12px;">
      Conservator assessment
    </h1>
  </div>

  <form id="form">
    <section class="card mb-4 shadow rounded-4">
      <h2>1. Assessment overview</h2>
      <div id="overview">
        <div class="field-row">
          <div class="field">
            <label for="client">Client</label>
            <input id="client" type="text" name="client" placeholder="Client / policy holder / claim reference" class="form-control">
          </div>
          <div class="field">
            <label for="assessor">Assessor</label>
            <input id="assessor" type="text" name="assessor" placeholder="Your name" class="form-control">
          </div>
        </div>
        <div class="item-peril-row">
          <div class="field">
            <label for="itemType">Item type</label>
            <select name="itemType" id="itemType" class="form-select"></select>
          </div>
          <div class="field peril-wrap">
            <label>Peril type</label>
            <div class="chips">
              <span class="chip"><input type="radio" id="peril_fire"  name="peril" value="Fire"><label for="peril_fire">Fire</label></span>
              <span class="chip"><input type="radio" id="peril_flood" name="peril" value="Flood"><label for="peril_flood">Flood</label></span>
              <span class="chip"><input type="radio" id="peril_acc"   name="peril" value="Accidental Damage"><label for="peril_acc">Accidental Damage</label></span>
              <span class="chip"><input type="radio" id="peril_other" name="peril" value="Other"><label for="peril_other">Other</label></span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card mb-4 shadow rounded-4">
      <h2>2. Item details &amp; impact</h2>
      <div class="row g-4">
        <div class="col-12 col-md-6"><label>Title / Description</label><input type="text" name="title" class="form-control"></div>
        <div class="col-12 col-md-6"><label>Artist / Maker</label><input type="text" name="artist" class="form-control"></div>
      </div>
      <div class="row g-4">
        <div class="col-12 col-md-6"><label>Date</label><input type="text" name="date" placeholder="c. 1900 / 20th C / unknown" class="form-control"></div>
        <div class="col-12 col-md-6"><label>Material</label><input type="text" name="material" placeholder="Oil on canvas / oak / …" class="form-control"></div>
      </div>
      <div class="row g-4">
        <div class="col-12 col-md-6"><label>Dimensions</label><input type="text" name="dimensions" placeholder="H × W × D / framed / unframed" class="form-control"></div>
        <div class="col-12 col-md-6"><label>Distinctive features</label><input type="text" name="features" placeholder="Signatures, labels, provenance, etc." class="form-control"></div>
      </div>

      <h3 style="margin-top:6px">Incident impact level</h3>
      <div class="note">Choose the overall impact level that best reflects the extent and severity of incident-related damage.</div>
      <div class="chips">
        <span class="chip"><input type="radio" id="impact_none" name="impact" value="None"><label for="impact_none">None</label></span>
        <span class="chip"><input type="radio" id="impact_low"  name="impact" value="Low"><label for="impact_low">Low</label></span>
        <span class="chip"><input type="radio" id="impact_med"  name="impact" value="Medium"><label for="impact_med">Medium</label></span>
        <span class="chip"><input type="radio" id="impact_high" name="impact" value="High"><label for="impact_high">High</label></span>
      </div>
    </section>

    <section class="card mb-4 shadow rounded-4" id="incidentSection">
      <h2>3. Incident findings</h2>
      <div id="checklists"></div>

      <div class="summary" id="selectedBox">
        <h4 id="selectedTitle">Selected Issues</h4>
        <div id="selectedContent" class="selected"></div>
      </div>

      <div id="incidentNotesBox">
        <label style="margin-top:12px">Additional incident notes</label>
        <textarea id="incidentNotes" rows="3" placeholder="Optional details…" class="form-control"></textarea>
      </div>
    </section>

    <section class="card mb-4 shadow rounded-4">
      <h2>4. Historic issues present?</h2>
      <div class="chips">
        <span class="chip"><input type="radio" id="hist_yes" name="hist" value="yes"><label for="hist_yes">Yes</label></span>
        <span class="chip"><input type="radio" id="hist_wear" name="hist" value="wear"><label for="hist_wear">Wear and Tear</label></span>
        <span class="chip"><input type="radio" id="hist_no"  name="hist" value="no"><label for="hist_no">No</label></span>
      </div>
      <div id="hist_notes_box" class="hide" style="display:none;">
        <label>Historic issues</label>
        <textarea rows="3" placeholder="Brief details…" class="form-control"></textarea>
      </div>
    </section>

    <section class="card mb-4 shadow rounded-4">
      <h2>5. Other notes</h2>
      <label>Other notes</label>
      <textarea id="otherNotes" rows="3" placeholder="Anything else relevant (e.g., keys, items stored in drawers, accessories)…" class="form-control"></textarea>
    </section>

    <section class="card mb-4 shadow rounded-4">
      <h2>6. Treatment time (incident)</h2>

      <div class="treatbar">
        <div class="quick">
          <label>Quick pick</label>
          <div class="chips" id="timeQuick">
            <span class="chip" data-minutes="15"><label>15 min</label></span>
            <span class="chip" data-minutes="30"><label>30 min</label></span>
            <span class="chip" data-minutes="45"><label>45 min</label></span>
            <span class="chip" data-minutes="60"><label>1 hour</label></span>
          </div>
        </div>
        <div class="treatcustom">
          <label>Custom time</label>
          <div class="inputs">
            <input id="treatmentAmount" type="number" step="0.01" min="0" placeholder="e.g., 15 or 0.25" class="form-control">
            <select id="treatmentUnit" class="form-select">
              <option value="minutes">minutes</option>
              <option value="hours">hours</option>
            </select>
          </div>
        </div>
      </div>
      <p class="note" id="timePreview">Enter a number, then choose minutes or hours.</p>
    </section>

    <section class="card mb-4 shadow rounded-4">
      <h2>7. Photos</h2>
      <button class="btn btn-primary btn-lg w-100 rounded-pill d-flex align-items-center justify-content-center gap-2" type="button" id="openCamera" data-bs-toggle="modal" data-bs-target="#cameraModal"><i class="bi bi-camera-fill" aria-hidden="true"></i><span>Use camera</span></button>
<input type="file" id="cameraFallback" accept="image/*" capture="environment" class="hide">
      <div class="photo-hint" id="photoHint">0/6 photos</div>
      <div class="thumbs" id="thumbs"></div>
      <div class="note">Saved to the client photo folder automatically.</div>
    </section>

    <section class="card mb-4 shadow rounded-4">
      <div class="footer" id="saveFooter">
        <button type="button" id="saveNext" class="btn btn- btn-primary btn-lg rounded-pill">Save &amp; next item</button>
      </div>
    </section>
  </form>
</div>

<!-- Sticky save bar -->
<div class="stickybar hide" id="stickyBar">
  <div class="inner container rounded-3 shadow-sm py-2">
    <button type="button" id="saveNextSticky" class="btn btn- btn-primary btn-lg rounded-pill">Save &amp; next item</button>
  </div>
</div>

<!-- Camera modal / Busy / Toast -->

<!-- Camera modal (Bootstrap) -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Use camera</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeCam"></button>
      </div>
      <div class="modal-body">
        <div class="ratio ratio-4x3 rounded border overflow-hidden">
          <video id="cam" autoplay playsinline class="w-100 h-100"></video>
          <canvas id="snap" class="d-none"></canvas>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" id="capture">Capture</button>
      </div>
    </div>
  </div>
</div>
<div class="busy" id="busy"><div class="spinner"></div></div>
<div class="toast" id="toast"></div>

<script>
// ========================== Apps Script API over fetch =====================
const BASE_URL = 'https://script.google.com/a/macros/fineart-restoration.co.uk/s/AKfycbwBPils9yMe1ZrQFeEWXR2gqnsv9EMJNpIe44hUKZmd2Cwnx2eJ1EL650Edu0eh8p4w/exec';

async function apiCall(action, payload = {}) {
  const res = await fetch(BASE_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify({ action, ...payload })
  });
  const json = await res.json();
  if (!res.ok || json.error) {
    throw new Error(json.error || ('HTTP ' + res.status));
  }
  return json;
}

async function apiNewBatch(client, assessor) {
  return await apiCall('newBatch', { client, assessor });
}

async function apiSaveItem(payload) {
  return await apiCall('saveItem', { payload });
}

async function apiSavePhotos(batchId, itemId, photos) {
  return await apiCall('savePhotos', { batchId, itemId, photos });
}
// ==========================================================================
</script>

<script>
/* -------------------------------------------------
   JS helpers that must exist before we render
--------------------------------------------------*/
// Safe no-op so calls don’t explode
function rebuildGroupSummary(/* group */) {}

/* ---------- Data ---------- */
const TYPE_OPTIONS = {
  "Painting (unframed)": {
    global: ["Surface dirt layer","Soot and contaminant layer","Odour","Mould contamination"],
    local:  ["Cracking/flaking","Friable paint","Areas of loss","Loss of tension","Deformations","Warping","Structural weakness","Tears in the canvas","Tears to the margins","Blanched varnish","Degraded varnish","Abrasions to surface","Scratches to surface","Water staining","Tidelines"]
  },
  "Amateur/Sentimental Artworks": {
    global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination"],
    local:  ["Cracking/flaking","Friable paint","Areas of loss","Loss of tension","Deformations","Warping","Structural weakness","Tears in the canvas","Tears to the margins","Blanched varnish","Degraded varnish","Abrasions to surface","Scratches to surface","Water staining","Tidelines"]
  },
  "Contemporary Artworks": {
    global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination"],
    local:  ["Cracking/flaking","Friable paint","Areas of loss","Loss of tension","Deformations","Warping","Structural weakness","Tears in the canvas","Tears to the margins","Blanched varnish","Degraded varnish","Abrasions to surface","Scratches to surface","Water staining","Tidelines"]
  },
  "Painting (framed)": [
    { title: "Artwork",
      global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination"],
      local:  ["Cracking/flaking","Friable paint","Areas of loss","Loss of tension","Deformations","Warping","Structural weakness","Tears in the canvas","Tears to the margins","Blanched varnish","Degraded varnish","Abrasions to surface","Scratches to surface","Water staining","Tidelines"] },
    { title: "Frame",
      global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination"],
      local:  [
        "Cracking/flaking gilding or gesso",
        "Blistered surface finish",
        "Cracking to decoration",
        "Structural weakness of joins",
        "Warping",
        "Losses to decoration",
        "Small losses across surface",
        "Abrasions to surface",
        "Scratches to surface",
        "Damaged glazing",
        "Damaged mirror"
      ] }
  ],
  "Gilt Frame / Mirror": {
    global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination"],
    local:  [
      "Cracking/flaking gilding or gesso",
      "Blistered surface finish",
      "Cracking to decoration",
      "Structural weakness of joins",
      "Warping",
      "Losses to decoration",
      "Small losses across surface",
      "Abrasions to surface",
      "Scratches to surface",
      "Damaged glazing",
      "Damaged mirror"
    ]
  },
  "Work on Paper (unframed)": {
    global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination"],
    local:  ["Deformations in substrate","Cockling of substrate","Tears in substrate","Media loss","Friable media","Tidelines","Water staining and discolouration","Abrasions to surface","Scratches to surface"]
  },
  "Work on Paper (framed)": [
    { title: "Artwork",
      global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination"],
      local:  ["Deformations in substrate","Cockling of substrate","Tears in substrate","Media loss","Friable media","Tidelines","Water staining and discolouration","Abrasions to surface","Scratches to surface"] },
    { title: "Frame",
      global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination"],
      local:  ["Impacted backboard","Impacted hanging fixtures","Impacted framing tape","Impacted mount","Impacted glazing","Impacted surface finish to frame"] }
  ],
  "Furniture": {
    global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination","Oxidation of metal elements","Degraded coating layers"],
    local:  [
      "Warping of wooden elements",
      "Swelling of wooden elements",
      "Structural join weakness",
      "Breakages of structure",
      "Losses to structure",
      "Lifting veneer",
      "Lost veneer",
      "Cracks and splits in the wood",
      "Water staining",
      "Tidelines",
      "Abrasions to surface",
      "Scratches to surface",
      "Damage to leather elements",
      "Losses or scratches to leather"
    ]
  },
  "Ceramics": {
    global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination","Impacted coating layers","Water staining","Tidelines"],
    local:  ["Cracking to finish","Structural cracking","Areas of structural weakness","Breakages","Losses"]
  },
  "Objects": {
    global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination","Impacted coating layers","Water staining","Tidelines"],
    local:  ["Cracking to finish","Structural cracking","Areas of structural weakness","Breakages","Losses"]
  },
  "Rugs": {
    global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination","Water staining","Colour run / dye bleed"],
    local:  ["Threading","Tearing of fibres","Singing/burning of fabric"]
  },
  "Upholstered pieces": {
    global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination","Water staining to fabric","Water staining to wood","Discolouration of fabric","Swelling of wooden elements","Oxidation of metal elements","Degraded coating layers"],
    local:  ["Structural join weakness","Lifting veneer","Lost veneer","Cracks and splits in the wood","Tidelines on fabric","Tidelines on wood","Abrasions to surface","Scratches to surface"]
  },
  "Family photographs and miscellaneous": {
    global: ["Surface dirt layer","Soot layer (fire only)","Odour","Mould contamination","Water staining","Colour run / dye bleed"],
    local:  ["Items stuck together"]
  },
  "Textiles": {
    global: [
      "Surface dirt layer",
      "Soot layer (fire only)",
      "Odour",
      "Mould contamination",
      "Water staining (low/med severity)",
      "Water staining (high severity)",
      "Colour run / dye bleed"
    ],
    local: [
      "Threading",
      "Tears",
      "Singing/burning of fabric"
    ]
  }
};
const ITEMTYPE_ORDER=["Painting (framed)","Painting (unframed)","Work on Paper (framed)","Work on Paper (unframed)","Gilt Frame / Mirror","Amateur/Sentimental Artworks","Contemporary Artworks","Furniture","Upholstered pieces","Ceramics","Objects","Rugs","Textiles","Family photographs and miscellaneous"];

/* ---------- Populate item type ---------- */
const itemTypeSelect=document.getElementById('itemType');
itemTypeSelect.innerHTML="";
const ph=document.createElement('option');ph.textContent="— Select item type —";ph.value="";ph.selected=true;ph.hidden=true;itemTypeSelect.appendChild(ph);
const ordered=ITEMTYPE_ORDER.filter(k=>TYPE_OPTIONS[k]).concat(Object.keys(TYPE_OPTIONS).filter(k=>!ITEMTYPE_ORDER.includes(k)));
ordered.forEach(k=>{const o=document.createElement("option");o.value=k;o.textContent=k;itemTypeSelect.appendChild(o);});

const checklistsDiv=document.getElementById('checklists');
function slug(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');}
function peril(){return (document.querySelector('input[name="peril"]:checked')||{}).value||'';}

/* Replacement + reupholstery flags */
const REPLACEMENT_CODES = [
  'WOP_BACKBOARD_IMPACTED',
  'FRM_HARDWARE',
  'FRM_TAPE_FAIL',
  'WOP_MOUNT_IMPACTED',
  'FRM_GLAZING_DAMAGE',
  'FRM_FINISH_SEVERE',
  'FRM_GLAZING_DAMAGE',
  'damaged_mirror'
];
const REUPHOLSTERY_CODES = ['RUG_STAIN','RUG_COLOUR_RUN'];

/*
 * Canonical slug->OptionCode map per item type
 * (This is the single CODE_MAP block you asked to keep.)
 */
var CODE_MAP = {
  "Painting (unframed)": {
    "surface_dirt_layer": "PNT_PARTICULATE",
    "odour": "PNT_ODOR",
    "mould_contamination": "PNT_MOULD",
    "soot_and_contaminant_layer": "PNT_SOOT",
    "cracking_flaking": "PNT_LIFTING",
    "friable_paint": "PNT_FRIABLE",
    "areas_of_loss": "PNT_LOSS",
    "loss_of_tension": "PNT_STRETCHER_KEYS",
    "deformations": "PNT_DEFORMATION",
    "warping": "PNT_WARPING",
    "structural_weakness": "PNT_STRUCTURE",
    "tears_in_the_canvas": "PNT_TEAR",
    "tears_to_the_margins": "PNT_TEAR_MARGINS",
    "blanched_varnish": "PNT_VARNISH_BLANCHED",
    "degraded_varnish": "PNT_VARNISH_IMPACTED",
    "abrasions_to_surface": "PNT_ABRASION",
    "scratches_to_surface": "PNT_SCRATCH",
    "water_staining": "PNT_WATER_STAIN",
    "tidelines": "PNT_TIDELINES"
  },
  "Amateur/Sentimental Artworks": {
    "surface_dirt_layer": "PNT_PARTICULATE",
    "odour": "PNT_ODOR",
    "mould_contamination": "PNT_MOULD",
    "soot_and_contaminant_layer": "PNT_SOOT",
    "cracking_flaking": "PNT_LIFTING",
    "areas_of_loss": "PNT_LOSS",
    "loss_of_tension": "PNT_STRETCHER_KEYS",
    "deformations": "PNT_DEFORMATION",
    "warping": "PNT_WARPING",
    "structural_weakness": "PNT_STRUCTURE",
    "tears_in_the_canvas": "PNT_TEAR",
    "tears_to_the_margins": "PNT_TEAR_MARGINS",
    "blanched_varnish": "PNT_VARNISH_BLANCHED",
    "degraded_varnish": "PNT_VARNISH_IMPACTED",
    "abrasions_to_surface": "PNT_ABRASION",
    "scratches_to_surface": "PNT_SCRATCH",
    "water_staining": "PNT_WATER_STAIN",
    "tidelines": "PNT_TIDELINES"
  },
  "Contemporary Artworks": {
    "surface_dirt_layer": "PNT_PARTICULATE",
    "odour": "PNT_ODOR",
    "mould_contamination": "PNT_MOULD",
    "soot_and_contaminant_layer": "PNT_SOOT",
    "cracking_flaking": "PNT_LIFTING",
    "areas_of_loss": "PNT_LOSS",
    "loss_of_tension": "PNT_STRETCHER_KEYS",
    "deformations": "PNT_DEFORMATION",
    "warping": "PNT_WARPING",
    "structural_weakness": "PNT_STRUCTURE",
    "tears_in_the_canvas": "PNT_TEAR",
    "tears_to_the_margins": "PNT_TEAR_MARGINS",
    "blanched_varnish": "PNT_VARNISH_BLANCHED",
    "degraded_varnish": "PNT_VARNISH_IMPACTED",
    "abrasions_to_surface": "PNT_ABRASION",
    "scratches_to_surface": "PNT_SCRATCH",
    "water_staining": "PNT_WATER_STAIN",
    "tidelines": "PNT_TIDELINES"
  },
  "Painting (framed)": {
    "surface_dirt_layer": "PNT_PARTICULATE",
    "odour": "PNT_ODOR",
    "mould_contamination": "PNT_MOULD",
    "soot_and_contaminant_layer": "PNT_SOOT",
    "cracking_flaking": "PNT_LIFTING",
    "areas_of_loss": "PNT_LOSS",
    "loss_of_tension": "PNT_STRETCHER_KEYS",
    "deformations": "PNT_DEFORMATION",
    "warping": "PNT_WARPING",
    "structural_weakness": "PNT_STRUCTURE",
    "tears_in_the_canvas": "PNT_TEAR",
    "tears_to_the_margins": "PNT_TEAR_MARGINS",
    "blanched_varnish": "PNT_VARNISH_BLANCHED",
    "degraded_varnish": "PNT_VARNISH_IMPACTED",
    "abrasions_to_surface": "PNT_ABRASION",
    "scratches_to_surface": "PNT_SCRATCH",
    "water_staining": "PNT_WATER_STAIN",
    "tidelines": "PNT_TIDELINES",
    "cracking_flaking_gilding_or_gesso": "GILT_LIFTING",
    "blistered_surface_finish": "FRM_FINISH_SEVERE",
    "cracking_to_decoration": "GILT_ORNAMENT_CRACK",
    "structural_weakness_of_joins": "FRM_STRUCT",
    "warping_frame": "FRM_WARP",
    "losses_to_decoration": "FRM_DEC_LOSS",
    "small_losses_across_surface": "FRM_SMALL_LOSS",
    "abrasions_to_surface_frame": "FRM_ABRASION",
    "scratches_to_surface_frame": "FRM_SCRATCH",
    "damaged_glazing": "FRM_GLAZING_DAMAGE"
  },
  "Gilt Frame / Mirror": {
    "surface_dirt_layer": "FRM_PARTICULATE",
    "odour": "FRM_ODOR",
    "mould_contamination": "FRM_MOULD",
    "soot_and_contaminant_layer": "FRM_SOOT",
    "cracking_flaking_gilding_or_gesso": "GILT_LIFTING",
    "blistered_surface_finish": "FRM_FINISH_SEVERE",
    "cracking_to_decoration": "GILT_ORNAMENT_CRACK",
    "structural_weakness_of_joins": "FRM_STRUCT",
    "warping": "FRM_WARP",
    "losses_to_decoration": "FRM_DEC_LOSS",
    "small_losses_across_surface": "FRM_SMALL_LOSS",
    "abrasions_to_surface": "FRM_ABRASION",
    "scratches_to_surface": "FRM_SCRATCH",
    "damaged_glazing": "FRM_GLAZING_DAMAGE",
    "damaged_mirror": "FRM_DAMAGE_MIRROR"
  },
  "Work on Paper (unframed)": {
    "surface_dirt_layer": "WOP_PARTICULATE",
    "odour": "WOP_ODOR",
    "mould_contamination": "WOP_MOULD",
    "deformations_in_substrate": "WOP_DEF",
    "cockling_of_substrate": "WOP_COCKLING",
    "tears_in_substrate": "WOP_TEAR",
    "media_loss": "WOP_MEDIA_LOSS",
    "friable_media": "WOP_FRIABLE",
    "tidelines": "WOP_TIDELINE",
    "water_staining_and_discolouration": "WOP_STAINING",
    "abrasions_to_surface": "WOP_ABRASION",
    "scratches_to_surface": "WOP_SCRATCH",
    "soot_and_contaminant_layer": "WOP_SOOT"
  },
  "Work on Paper (framed)": {
    "surface_dirt_layer": "WOP_PARTICULATE",
    "odour": "WOP_ODOR",
    "mould_contamination": "WOP_MOULD",
    "deformations_in_substrate": "WOP_DEF",
    "cockling_of_substrate": "WOP_COCKLING",
    "tears_in_substrate": "WOP_TEAR",
    "media_loss": "WOP_MEDIA_LOSS",
    "friable_media": "WOP_FRIABLE",
    "tidelines": "WOP_TIDELINE",
    "water_staining_and_discolouration": "WOP_STAINING",
    "abrasions_to_surface": "WOP_ABRASION",
    "scratches_to_surface": "WOP_SCRATCH",
    "impacted_backboard": "WOP_BACKBOARD_IMPACTED",
    "impacted_hanging_fixtures": "WOP_HARDWARE",
    "impacted_framing_tape": "WOP_TAPE_FAIL",
    "impacted_mount": "WOP_MOUNT_IMPACTED",
    "impacted_glazing": "FRM_GLAZING_DAMAGE",
    "impacted_surface_finish_to_frame": "WOP_FRAME_FINISH_IMPACTED",
    "soot_and_contaminant_layer": "WOP_SOOT"
  },
  "Family photographs and miscellaneous": {
    "surface_dirt_layer": "WOP_PARTICULATE",
    "odour": "WOP_ODOR",
    "mould_contamination": "WOP_MOULD",
    "water_staining": "WOP_STAINING",
    "colour_run_dye_bleed": "WOP_COLOUR_RUN",
    "soot_and_contaminant_layer": "WOP_SOOT"
  },
  "Furniture": {
    "surface_dirt_layer": "INCIDENT_PARTICULATE",
    "odour": "INCIDENT_ODOR",
    "mould_contamination": "INCIDENT_MOULD_TRACE",
    "oxidation_of_metal_elements": "METAL_OXIDATION",
    "degraded_coating_layers": "FINISH_DISRUPTED",
    "warping_of_wooden_elements": "FURN_WARP",
    "swelling_of_wooden_elements": "FURN_SWELL",
    "structural_join_weakness": "JOINTS_LOOSE",
    "breakages_of_structure": "STRUCT_BREAKAGE",
    "losses_to_structure": "STRUCT_DAMAGED",
    "lifting_veneer": "VENEER_LIFTING",
    "lost_veneer": "VENEER_LOSS",
    "cracks_and_splits_in_the_wood": "FURN_CRACK",
    "water_staining": "FURN_STAIN",
    "tidelines": "FURN_TIDELINE",
    "abrasions_to_surface": "FURN_ABRASION",
    "scratches_to_surface": "FURN_SCRATCH",
    "damage_to_leather_elements": "LEATHER_DRY",
    "losses_or_scratches_to_leather": "LEATHER_LOSS",
    "soot_and_contaminant_layer": "INCIDENT_SOOT"
  },
  "Upholstered pieces": {
    "surface_dirt_layer": "INCIDENT_PARTICULATE",
    "odour": "INCIDENT_ODOR",
    "mould_contamination": "INCIDENT_MOULD_TRACE",
    "water_staining_to_fabric": "FAB_STAIN",
    "water_staining_to_wood": "FURN_STAIN",
    "discolouration_of_fabric": "FAB_DISCOLOUR",
    "swelling_of_wooden_elements": "FURN_SWELL",
    "degraded_coating_layers": "FINISH_DISRUPTED",
    "structural_join_weakness": "JOINTS_LOOSE",
    "lifting_veneer": "VENEER_LIFTING",
    "lost_veneer": "VENEER_LOSS",
    "cracks_and_splits_in_the_wood": "FURN_CRACK",
    "tidelines_on_fabric": "FAB_STAIN",
    "tidelines_on_wood": "FURN_TIDELINE",
    "abrasions_to_surface": "FURN_ABRASION",
    "scratches_to_surface": "FURN_SCRATCH",
    "soot_and_contaminant_layer": "TXT_SOOT"
  },
  "Ceramics": {
    "surface_dirt_layer": "OBJ_PARTICULATE",
    "odour": "INCIDENT_ODOR",
    "mould_contamination": "INCIDENT_MOULD_TRACE",
    "impacted_coating_layers": "CERAMIC_COATING",
    "water_staining": "CERAMIC_STAIN",
    "tidelines": "CERAMIC_TIDELINE",
    "cracking_to_finish": "CERAMIC_FINISH_CRACK",
    "structural_cracking": "CERAMIC_CRACK",
    "areas_of_structural_weakness": "CERAMIC_WEAK",
    "breakages": "CERAMIC_BREAK",
    "losses": "CERAMIC_CHIP",
    "soot_and_contaminant_layer": "OBJ_SOOT"
  },
  "Objects": {
    "surface_dirt_layer": "OBJ_PARTICULATE",
    "odour": "OBJ_ODOR",
    "mould_contamination": "OBJ_MOULD",
    "impacted_coating_layers": "FINISH_DISRUPTED",
    "water_staining": "CERAMIC_STAIN",
    "tidelines": "CERAMIC_TIDELINE",
    "cracking_to_finish": "CERAMIC_FINISH_CRACK",
    "structural_cracking": "CERAMIC_CRACK",
    "areas_of_structural_weakness": "CERAMIC_WEAK",
    "breakages": "CERAMIC_BREAK",
    "losses": "CERAMIC_CHIP",
    "soot_and_contaminant_layer": "OBJ_SOOT"
  },
  "Rugs": {
    "surface_dirt_layer": "TXT_PARTICULATE",
    "odour": "INCIDENT_ODOR",
    "mould_contamination": "INCIDENT_MOULD_TRACE",
    "water_staining": "RUG_STAIN",
    "colour_run_dye_bleed": "RUG_COLOUR_RUN",
    "threading": "TXT_TEAR",
    "tearing_of_fibres": "TXT_TEAR",
    "singing/burning_of_fabric": "RUG_BURN",
    "soot_and_contaminant_layer": "TXT_PARTICULATE"
  },
  "Textiles": {
    "surface_dirt_layer": "TXT_PARTICULATE",
    "odour": "TXT_ODOR",
    "mould_contamination": "TXT_MOULD",
    "water_staining_low_med_severity": "RUG_STAIN",
    "water_staining_high_severity": "RUG_STAIN_SEV",
    "colour_run_dye_bleed": "RUG_COLOUR_RUN",
    "threading": "TXT_TEAR",
    "tears": "TXT_TEAR",
    "singing/burning_of_fabric": "RUG_BURN",
    "soot_and_contaminant_layer": "TXT_PARTICULATE"
  }
};

/* Normalize labels per peril */
function normalizeItems(items){
  const p = peril();
  const itemType = document.getElementById('itemType').value;
  const out=[];
  const seen=new Set();
  (items||[]).forEach(raw=>{
    const original = Array.isArray(raw) ? raw[1] : raw;
    let label = original;
    if(p !== 'Fire' && /\(fire only\)/i.test(original)) return;
    if(p === 'Fire'){
      if(/^soot layer\s*\(fire only\)$/i.test(original)) return;
      if(/^surface dirt layer$/i.test(original)) label = 'Soot and contaminant layer';
    }
    const s = slug(label);
    let code;
    if(Array.isArray(raw)){
      code = raw[0];
    } else {
      const map = CODE_MAP[itemType] || {};
      code = map[s] || s;
    }
    if(!seen.has(label)){
      seen.add(label);
      out.push([code,label]);
    }
  });
  return out;
}

function makeToolbar(groupRoot){
  const tb=document.createElement('div');tb.className='toolbar';
  const mini=document.createElement('div');mini.className='mini';
  const clearBtn=document.createElement('button');clearBtn.type='button';clearBtn.className='btnlink';clearBtn.textContent='Clear';
  mini.appendChild(clearBtn);tb.appendChild(mini);
  clearBtn.addEventListener('click',()=>{
    groupRoot.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.checked=false;cb.dispatchEvent(new Event('change', { bubbles: true }));
    });
    groupRoot.querySelectorAll('.inline input[type="text"]').forEach(inp=>{ inp.value=''; });
  });
  groupRoot.appendChild(tb);
}

function makeGrid(items,isLocal){
  const wrap=document.createElement('div');wrap.className='checkgrid';
  normalizeItems(items).forEach(([code,label])=>{
    const cell=document.createElement('div');cell.className='checkitem';
    const id='opt_'+code+'_'+Math.random().toString(36).slice(2,6);
    const input=document.createElement('input');input.type='checkbox';input.id=id;input.dataset.code=code;input.dataset.local=isLocal?'1':'0';
    const lab=document.createElement('label');lab.setAttribute('for',id);lab.className='label';lab.textContent=label;
    cell.appendChild(input);cell.appendChild(lab);
    if(isLocal){
      const inline=document.createElement('div');inline.className='inline hide';
      inline.innerHTML='<input type="text" placeholder="Location (e.g., lower left)" class="form-control">';
      cell.appendChild(inline);
      if(REPLACEMENT_CODES.includes(code)){
        const repl=document.createElement('div');repl.className='replacement hide';
        const replLabel=document.createElement('label');
        const replInput=document.createElement('input');
        replInput.type='checkbox';
        replInput.className='replace-needed';
        replLabel.appendChild(replInput);
        replLabel.appendChild(document.createTextNode(' Replacement needed?'));
        repl.appendChild(replLabel);
        cell.appendChild(repl);
      }
      if(REUPHOLSTERY_CODES.includes(code)){
        const reuph=document.createElement('div');reuph.className='reupholstery hide';
        const reuphLabel=document.createElement('label');
        const reuphInput=document.createElement('input');
        reuphInput.type='checkbox';
        reuphInput.className='reupholstery-needed';
        reuphLabel.appendChild(reuphInput);
        reuphLabel.appendChild(document.createTextNode(' Reupholstery needed?'));
        reuph.appendChild(reuphLabel);
        cell.appendChild(reuph);
      }
    }
    wrap.appendChild(cell);
  });
  return wrap;
}
function makeGroup(title,items,isLocal){
  const box=document.createElement('div');box.className='group';
  const h=document.createElement('h4');h.textContent=title;h.dataset.base=title;box.appendChild(h);
  makeToolbar(box);
  const grid=makeGrid(items,isLocal);box.appendChild(grid);
  return box;
}
function makeTabs(tabDefs){
  const tabsWrap=document.createElement('div');
  const bar=document.createElement('div');bar.className='tabs';
  const panels=[];
  tabDefs.forEach((def,i)=>{
    const btn=document.createElement('button');btn.type='button';btn.className='tab-btn'+(i===0?' active':'');btn.innerHTML=def.title+' <span class="badge">0</span>';
    const panel=document.createElement('div');panel.className='tabpanel'+(i===0?' active':'');panel.appendChild(makeGroup('Localised Issues',def.items,true));panels.push(panel);
    btn.addEventListener('click',()=>{bar.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');panels.forEach(p=>p.classList.remove('active'));panel.classList.add('active');});
    bar.appendChild(btn);
  });
  tabsWrap.appendChild(bar);panels.forEach(p=>tabsWrap.appendChild(p));
  tabsWrap._buttons=bar.querySelectorAll('.tab-btn');tabsWrap._panels=panels;
  return tabsWrap;
}
function combinedUnique(listA,listB){return normalizeItems([...(listA||[]),...(listB||[])]);}

function renderChecklists(){
  const t=itemTypeSelect.value;checklistsDiv.innerHTML="";if(!t) return;
  const data=TYPE_OPTIONS[t];
  if(Array.isArray(data)){
    const art=data.find(g=>/artwork/i.test(g.title))||data[0];
    const frm=data.find(g=>/frame/i.test(g.title))||data[1];
    const globalBox=makeGroup('Global Issues',combinedUnique(art.global,frm.global),false);checklistsDiv.appendChild(globalBox);
    const tabs=makeTabs([{title:'Artwork',items:art.local||[]},{title:'Frame',items:frm.local||[]}]);checklistsDiv.appendChild(tabs);
  }else{
    if((data.global||[]).length) checklistsDiv.appendChild(makeGroup('Global Issues',data.global,false));
    checklistsDiv.appendChild(makeGroup('Localised Issues',data.local||[],true));
  }
  refreshAllCounts();
  document.querySelectorAll('#checklists .group').forEach(g=>rebuildGroupSummary(g));
  rebuildSummary();
  try { updateIncidentNoneMessage(); } catch(e){}
}
document.querySelectorAll('input[name="peril"]').forEach(r=>r.addEventListener('change',renderChecklists));
itemTypeSelect.addEventListener('change',renderChecklists);

/* Toggle location visibility + styles + counts */
checklistsDiv.addEventListener('change',e=>{
  if(e.target && e.target.matches('input[type="checkbox"]')){
    const cell=e.target.closest('.checkitem'); if(!cell) return;
    cell.classList.toggle('checked',e.target.checked);
    const inline = cell.querySelector('.inline');
    if(inline && e.target.dataset.local==='1'){ inline.classList.toggle('hide',!e.target.checked); }
    const repl = cell.querySelector('.replacement');
    if(repl && e.target.dataset.local==='1'){ repl.classList.toggle('hide',!e.target.checked); }
    const grp = cell.closest('.group');
    updateGroupCount(grp);updateTabBadges();rebuildSummary();
  }
});
checklistsDiv.addEventListener('input',e=>{if(e.target && e.target.closest('.inline')){const grp=e.target.closest('.group');rebuildGroupSummary(grp);rebuildSummary();}});

/* --- Stronger listener to update meta when typing location --- */
checklistsDiv.addEventListener('input', (e)=>{
  if (e.target && e.target.matches('.inline input[type="text"]')) {
    const grp = e.target.closest('.group');
    if (grp) { try { rebuildGroupSummary(grp); } catch(e){} }
    rebuildSummary();
  }
});
checklistsDiv.addEventListener('change', (e)=>{
  if (e.target && e.target.matches('.inline input[type="text"]')) {
    const grp = e.target.closest('.group');
    if (grp) { try { rebuildGroupSummary(grp); } catch(e){} }
    rebuildSummary();
  }
});
function updateGroupCount(groupEl){
  if(!groupEl) return;
  const h=groupEl.querySelector('h4'); if(!h) return;
  const base=h.dataset.base||h.textContent;
  const count=groupEl.querySelectorAll('.checkitem input[type="checkbox"][data-code]:checked').length;
  h.textContent=count?`${base} (${count})`:base;
}
function refreshAllCounts(){
  document.querySelectorAll('.group').forEach(g=>updateGroupCount(g));
  refreshSelectedStyles();
  updateTabBadges();
}

function refreshSelectedStyles(){
  document.querySelectorAll('.checkitem').forEach(cell=>{
    const cb = cell.querySelector('input[type="checkbox"]');
    cell.classList.toggle('checked', cb && cb.checked);
    const inline = cell.querySelector('.inline');
    if(inline && cb){
      inline.classList.toggle('hide', !(cb.checked && cb.dataset.local==='1'));
    }
    const repl = cell.querySelector('.replacement');
    if(repl && cb){
      repl.classList.toggle('hide', !(cb.checked && cb.dataset.local==='1'));
    }
    const reuph = cell.querySelector('.reupholstery');
    if(reuph && cb){
      reuph.classList.toggle('hide', !(cb.checked && cb.dataset.local==='1'));
    }
  });
}

function updateTabBadges(){
  checklistsDiv.querySelectorAll('.tabs').forEach(bar => {
    const wrap = bar.parentElement;
    const btns = wrap._buttons;
    const panels = wrap._panels;
    if (!btns || !panels) return;
    panels.forEach((p, i) => {
      const c = p.querySelectorAll('.checkitem input[type="checkbox"][data-code]:checked').length;
      const b = btns[i].querySelector('.badge');
      if (b) b.textContent = c;
    });
  });
}

/* Summary */
function rebuildSummary(){
  const selected = [];
  function cleanTabLabel(btn){
    if(!btn) return '';
    const clone = btn.cloneNode(true);
    const badge = clone.querySelector('.badge'); if(badge) badge.remove();
    return clone.textContent.trim();
  }
  document.querySelectorAll('#checklists .group').forEach(group=>{
    let tag = '';
    const tp = group.closest('.tabpanel');
    if (tp){
      const wrap = tp.parentElement;
      const buttons = wrap?._buttons || wrap.querySelectorAll('.tab-btn');
      const panels  = wrap?._panels  || wrap.querySelectorAll('.tabpanel');
      let idx = -1;
      panels.forEach((p,i)=>{ if(p===tp) idx=i; });
      if (idx>-1 && buttons[idx]) tag = cleanTabLabel(buttons[idx]);
    }
    group.querySelectorAll('.checkitem input[type="checkbox"][data-code]:checked').forEach(cb=>{
      const cell = cb.closest('.checkitem');
      const labelEl = cell.querySelector('.label');
      const label = labelEl ? labelEl.textContent : '';
      const locInput = cell.querySelector('.inline input');
      const loc = locInput ? locInput.value.trim() : '';
      const replInput = cell.querySelector('input.replace-needed');
      const reuphInput = cell.querySelector('input.reupholstery-needed');
      const repl = replInput ? replInput.checked : false;
      const reuph = reuphInput ? reuphInput.checked : false;
      const parts = [];
      if (tag) parts.push(tag);
      if (loc) parts.push(loc);
      if (repl) parts.push('Replacement');
      if (reuph) parts.push('Reupholstery');
      selected.push({label: label, meta: parts.join(' · '), id: cb.id});
    });
  });
  const box=document.getElementById('selectedContent');
  const title=document.getElementById('selectedTitle');
  box.innerHTML='';
  if (title) title.textContent = `Selected Issues (${selected.length})`;
  const grid=document.createElement('div'); grid.className='selgrid';
  selected.forEach(it=>{
    const row=document.createElement('div'); row.className='selrow';
    const t=document.createElement('div'); t.className='title'; t.textContent=it.label; row.appendChild(t);
    const meta=document.createElement('div'); meta.className='meta';
    meta.textContent = it.meta || '';
    row.appendChild(meta);
    const x=document.createElement('button'); x.type='button'; x.className='pillx'; x.textContent='×'; x.title='Remove';
    x.addEventListener('click',()=>{const el=document.getElementById(it.id); if(el){ el.checked=false; el.dispatchEvent(new Event('change', {bubbles:true})); }});
    row.appendChild(x);
    grid.appendChild(row);
  });
  box.appendChild(grid);
}

// initial render & visibility hooks
renderChecklists(); updateIncidentNoneMessage(); updateIncidentNotesVisibility();

/* Impact level -> message in Incident Findings (when 'None') */
function updateIncidentNoneMessage(){
  const val = document.querySelector('input[name="impact"]:checked')?.value || '';
  const none = String(val).toLowerCase() === 'none';
  const checklistsDiv = document.getElementById('checklists');
  const selectedTitle = document.getElementById('selectedTitle');
  const selectedContent = document.getElementById('selectedContent');
  const notesBox = document.getElementById('incidentNotesBox');
  if (notesBox) notesBox.classList.toggle('hide', none);
  if (!checklistsDiv || !selectedTitle || !selectedContent) return;
  if (none){
    checklistsDiv.classList.add('hide');
    selectedTitle.textContent = 'Incident findings';
    selectedContent.innerHTML = '<div class="note">No incident impact observed.</div>';
  } else {
    checklistsDiv.classList.remove('hide');
    selectedTitle.textContent = 'Selected Issues';
    if (!checklistsDiv.children.length){
      renderChecklists();
    }
    rebuildSummary();
  }
}
document.querySelectorAll('input[name="impact"]').forEach(r=>r.addEventListener('change', updateIncidentNoneMessage));
updateIncidentNoneMessage();

/* Additional incident notes -> visible except when impact = None */
function updateIncidentNotesVisibility(){
  const val = document.querySelector('input[name="impact"]:checked')?.value || '';
  const box = document.getElementById('incidentNotesBox');
  if (!box) return;
  const show = (String(val).toLowerCase() !== 'none');
  box.classList.toggle('hide', !show);
}
document.querySelectorAll('input[name="impact"]').forEach(r=>r.addEventListener('change', updateIncidentNotesVisibility));
updateIncidentNotesVisibility();

/* Proxy for legacy */
function updateIncidentVisibility(){
  try { updateIncidentNoneMessage(); } catch (e) {}
  try { updateIncidentNotesVisibility(); } catch (e) {}
}

function updateHistVisibility(){
  const val = document.querySelector('input[name="hist"]:checked')?.value || '';
  const box = document.getElementById('hist_notes_box');
  const show = (val==='yes' || val==='wear');
  if (show){
    box.classList.remove('hide');
    box.style.display='';
    const ta = box.querySelector('textarea'); if (ta) setTimeout(()=>ta.focus(), 0);
  }else{
    box.classList.add('hide');
    box.style.display='none';
  }
}
document.querySelectorAll('input[name="hist"]').forEach(r=>r.addEventListener('change',updateHistVisibility));
updateHistVisibility();

/* Treatment time UX */

function syncTimeQuickSelection(){
  const container = document.getElementById('timeQuick');
  if(!container) return;
  const amt = document.getElementById('treatmentAmount')?.value ?? '';
  const unit = document.getElementById('treatmentUnit')?.value ?? 'minutes';
  const min = ttNormalizeMinutes(amt, unit);
  const chips = container.querySelectorAll('.chip');
  chips.forEach(ch => {
    const m = parseFloat(ch.getAttribute('data-minutes'));
    if(min !== '' && parseFloat(min) === m){ ch.classList.add('active'); }
    else { ch.classList.remove('active'); }
  });
}
function ttNormalizeMinutes(amount, unit){
  let a = parseFloat(amount);
  if(isNaN(a) || a < 0) return '';
  return unit === 'hours' ? Math.round(a*60*100)/100 : Math.round(a*100)/100;
}
function updateTreatmentPreview(){
  const amt = document.getElementById('treatmentAmount')?.value ?? '';
  const unit = document.getElementById('treatmentUnit')?.value ?? 'minutes';
  const min = ttNormalizeMinutes(amt, unit);
  const p = document.getElementById('timePreview');
  if(!p) return;
  p.textContent = (min === '') ? 'Enter a number, then choose minutes or hours.' : `Will record as ${min} minutes.`;

  syncTimeQuickSelection();
}
['treatmentAmount','treatmentUnit'].forEach(id=>{
  const el = document.getElementById(id);
  if(el){ el.addEventListener('input', updateTreatmentPreview); el.addEventListener('change', updateTreatmentPreview); }
});
const timeQuick = document.getElementById('timeQuick');
if(timeQuick){
  timeQuick.addEventListener('click', (e)=>{
    const chip = e.target.closest('[data-minutes]');
    if(!chip) return;
    const minutes = parseFloat(chip.getAttribute('data-minutes'));
    const amtEl = document.getElementById('treatmentAmount');
    const unitEl = document.getElementById('treatmentUnit');
    if(!amtEl || !unitEl) return;
    
    // Toggle-off behaviour: clicking the active chip will clear the selection
    if (chip.classList.contains('active')){
      chip.classList.remove('active');
      amtEl.value = '';
      unitEl.value = 'minutes';
      updateTreatmentPreview();
      return;
    }
if(minutes >= 60){ unitEl.value = 'hours'; amtEl.value = Math.round((minutes/60)*100)/100; }
    else { unitEl.value = 'minutes'; amtEl.value = minutes; }
    amtEl.dispatchEvent(new Event('input'));
    unitEl.dispatchEvent(new Event('change'));
    updateTreatmentPreview();
    syncTimeQuickSelection();
  });
}
updateTreatmentPreview();

/* Camera + photos */
const modal=document.getElementById('cameraModal');
const openBtn=document.getElementById('openCamera');
const closeBtn=document.getElementById('closeCam');
const captureBtn=document.getElementById('capture');
const retakeBtn=null;
const video=document.getElementById('cam');
const canvas=document.getElementById('snap');
const thumbs=document.getElementById('thumbs');
let stream=null,queuedPhotos=[];
const PHOTO_LIMIT = 6;
function updatePhotoHint(){ const ph=document.getElementById('photoHint'); if(ph){ ph.textContent = `${queuedPhotos.length}/${PHOTO_LIMIT} photos`; } if(captureBtn){ captureBtn.disabled = queuedPhotos.length >= PHOTO_LIMIT; }}
openBtn.onclick=async()=>{document.body.classList.add('modal-open'); modal.style.display='flex'; updatePhotoHint();try{stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});video.srcObject=stream;video.classList.remove('hide');canvas.classList.add('hide');}catch(e){alert('Camera access was blocked.');}};
closeBtn.onclick=()=>{document.body.classList.remove('modal-open'); modal.style.display='none'; updatePhotoHint();if(stream) stream.getTracks().forEach(t=>t.stop());};
function captureToDataUrl(){const max=1800;const vw=video.videoWidth,vh=video.videoHeight;let w=vw,h=vh;if(Math.max(vw,vh)>max){const r=max/Math.max(vw,vh);w=Math.round(vw*r);h=Math.round(vh*r);}canvas.width=w;canvas.height=h;const ctx=canvas.getContext('2d');ctx.drawImage(video,0,0,w,h);return canvas.toDataURL('image/jpeg',0.85);}
captureBtn.onclick=()=>{
  if (queuedPhotos.length >= PHOTO_LIMIT){ showToast(`Photo limit reached (${PHOTO_LIMIT}).`); return; }

  const d = captureToDataUrl();
  queuedPhotos.push({dataUrl:d});
  const wrapper=document.createElement('div');
  wrapper.className='thumb';
  const img=document.createElement('img');
  img.src=d;
  wrapper.appendChild(img);
  const del=document.createElement('button');
  del.type='button';
  del.className='delete';
  del.setAttribute('aria-label','Delete photo');
  del.innerHTML = `<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
    <path d="M9 3h6l1 2h4v2H4V5h4l1-2z" fill="currentColor"/>
    <path d="M6 9h12l-1 11a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L6 9z" fill="currentColor"/>
    <path d="M10 12v7M14 12v7" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
  </svg>`;
  del.title='Delete photo';
  del.addEventListener('click',()=>{
    const nodes=Array.from(thumbs.children);
    const idx=nodes.indexOf(wrapper);
    if(idx>-1){queuedPhotos.splice(idx,1);}
    wrapper.remove(); updatePhotoHint();
  });
  wrapper.appendChild(del);
  thumbs.appendChild(wrapper);
  updatePhotoHint();
};

/* Sticky bar */
const stickyBar=document.getElementById('stickyBar');
const saveFooter=document.getElementById('saveFooter');
document.getElementById('saveNextSticky').addEventListener('click',()=>{document.getElementById('saveNext').click();});
const io=new IntersectionObserver(entries=>{entries.forEach(entry=>{if(entry.target===saveFooter){if(entry.isIntersecting){stickyBar.classList.remove('show');stickyBar.classList.add('hide');}else{stickyBar.classList.remove('hide');stickyBar.classList.add('show');}}});},{root:null,threshold:0.1});io.observe(saveFooter);

/* Busy/Toast + reset */
const busy=document.getElementById('busy');const toast=document.getElementById('toast');
function showBusy(on){busy.style.display=on?'flex':'none';}
function showToast(msg){toast.textContent=msg;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1800);}
function disableButtons(on){document.getElementById('saveNext').disabled=on;document.getElementById('saveNextSticky').disabled=on;}

function resetForNextItem(preserveType=true){
  // Always start a fresh batch for each saved item
  currentBatchId = null;

  const form=document.getElementById('form');
  const typeSel=document.getElementById('itemType');const lastType=typeSel.value;
  form.reset(); if(preserveType) typeSel.value=lastType;
  renderChecklists(); updateIncidentVisibility();document.querySelectorAll('input[name="hist"]').forEach(r=>r.checked=false);
  updateHistVisibility();document.getElementById('hist_notes_box').classList.add('hide');
  queuedPhotos.length=0;thumbs.innerHTML='';updatePhotoHint();if(modal.style.display==='flex') closeBtn.click();
}

/* Keyboard shortcuts */
document.addEventListener('keydown',e=>{
  if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='enter'){e.preventDefault();document.getElementById('saveNext').click();}
  if(!e.metaKey && !e.ctrlKey && ['1','2','3','4'].includes(e.key)){
    const idMap={'1':'impact_none','2':'impact_low','3':'impact_med','4':'impact_high'};const el=document.getElementById(idMap[e.key]);if(el){el.checked=true;el.dispatchEvent(new Event('change'));}
  }
});

/* Server bridge placeholders */
let currentBatchId=null;
async function ensureBatch(){
  if(currentBatchId) return currentBatchId;
  const client=document.querySelector('input[name="client"]').value.trim();
  const assessor=document.querySelector('input[name="assessor"]').value.trim();
  if(!client){showToast('Enter a client name.');throw new Error('no client');}
  if(!assessor){showToast('Enter an assessor name.');throw new Error('no assessor');}
  const res = await apiNewBatch(client, assessor);
  currentBatchId = res.batchId;
  return currentBatchId;
}
function buildPayload(batchId){
  const get=n=>document.querySelector(`[name="${n}"]`);
  const peril=(document.querySelector('input[name="peril"]:checked')||{}).value||'';
  const impact=(document.querySelector('input[name="impact"]:checked')||{}).value||'';
  const type=document.getElementById('itemType').value;
  const selections=[];
  document.querySelectorAll('#checklists input[type="checkbox"][data-code]').forEach(cb=>{
    if(!cb.checked) return;
    const local = cb.dataset.local === '1';
    const cell = cb.closest('.checkitem');
    const inline = cell && cell.querySelector('.inline');
    const loc = local && inline ? (inline.children[0]?.value || '') : '';
    const ext = '';
    const replInput = cell.querySelector('input.replace-needed');
    const reuphInput = cell.querySelector('input.reupholstery-needed');
    const notes = [];
    if(replInput && replInput.checked) notes.push('Replacement needed');
    if(reuphInput && reuphInput.checked) notes.push('Reupholstery needed');
    const note = notes.join('; ');
    selections.push({code:cb.dataset.code,localized:local,location:loc,extent:ext,note:note});
  });
  const histYes    = document.getElementById('hist_yes').checked;
  const histChoice = (document.querySelector('input[name="hist"]:checked')?.value || ''); // "yes" | "wear" | "no"
  // Capture notes when either "yes" OR "wear" is selected
  const histNotes = (histChoice === 'yes' || histChoice === 'wear')
    ? (document.querySelector('#hist_notes_box textarea')?.value || ''): '';
  const incidentNotes=(document.getElementById('incidentNotes')?.value || '').trim();
  const amtRaw=document.getElementById('treatmentAmount').value;const amt=amtRaw===''?'':Number(amtRaw);const unit=document.getElementById('treatmentUnit').value;
  let minutes=''; if(amt!=='' && !isNaN(amt) && amt>=0){minutes=unit==='hours'?Math.round(amt*60*100)/100:Math.round(amt*100)/100;}
  const treatmentDisplay=amt===''?'':(unit==='hours'?`${amt} hours`:`${amt} minutes`);
  return { batchId, peril, impact, type, title: get('title').value, artist: get('artist').value, material: get('material').value, date: get('date').value, dimensions: get('dimensions').value, features: get('features').value, historicCode: histChoice,
    historicYes: histYes, historicNotes: histNotes, selections, incidentNotes, TreatmentTimeMinutes: minutes, TreatmentTimeUnit: unit, TreatmentTime: treatmentDisplay };
}
async function uploadQueuedPhotos(batchId,itemId){
  if(!queuedPhotos.length) return;
  const photos=queuedPhotos.splice(0);
  const res = await apiSavePhotos(batchId, itemId, photos);
  showToast(`Photos saved (${res.saved})`);
}
document.getElementById('saveNext').addEventListener('click',async()=>{
  try{
    disableButtons(true);showBusy(true);
    const b=await ensureBatch();const payload=buildPayload(b);
    payload.otherNotes=(document.getElementById('otherNotes')?.value||'').trim();
    google.script.run.withSuccessHandler(async(res)=>{
      await uploadQueuedPhotos(b,res.itemId);showToast('Saved — next item ready');currentBatchId = null;
      resetForNextItem(true);disableButtons(false);showBusy(false);
    }).withFailureHandler(err=>{alert(err.message||err);disableButtons(false);showBusy(false);}).saveItem(payload);
  }catch(e){disableButtons(false);showBusy(false);}
});

/* Hide sticky bar when keyboard is open on mobile */
if ('visualViewport' in window){
  const sb = document.getElementById('stickyBar');
  const update = () => {
    const kbOpen = window.visualViewport.height < window.innerHeight - 120;
    sb.style.visibility = kbOpen ? 'hidden' : 'visible';
  };
  visualViewport.addEventListener('resize', update);
  visualViewport.addEventListener('scroll', update);
  update();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</body>
</html>
